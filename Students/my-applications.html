<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Applications - EASECHOLAR</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/Assets/images/main_icon.png">
    <link rel="apple-touch-icon" href="/Assets/images/main_icon.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Mobile Responsive Styles -->
    <link rel="stylesheet" href="/Assets/css/mobile-responsive.css">

</head>
<body class="bg-gray-50 font-sans">
    <!-- Sidebar component (fixed) -->
    <div id="sidebar-container"></div>
    
    <!-- Navigation component (fixed) -->
    <div id="nav-container"></div>

    <!-- Main content with proper spacing for fixed sidebar and nav -->
    <div class="ml-0 lg:ml-64 pt-20 sm:pt-16">
        <div class="p-4 sm:p-6 lg:p-8">
            <!-- Page Header -->
            <div class="mb-6 sm:mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">My Applications</h1>
                <p class="text-sm sm:text-base text-gray-600">Track your scholarship applications and manage your submission progress.</p>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-6 sm:mb-8">
                <div class="bg-white p-3 sm:p-4 lg:p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex flex-col items-center text-center">
                        <div class="p-2 sm:p-3 rounded-full bg-blue-100 mb-2">
                            <i class="fas fa-file-alt text-blue-600 text-base sm:text-lg lg:text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1">Total</p>
                            <p id="stat-total" class="text-xl sm:text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-3 sm:p-4 lg:p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex flex-col items-center text-center">
                        <div class="p-2 sm:p-3 rounded-full bg-yellow-100 mb-2">
                            <i class="fas fa-clock text-yellow-600 text-base sm:text-lg lg:text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1">Review</p>
                            <p id="stat-review" class="text-xl sm:text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-3 sm:p-4 lg:p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex flex-col items-center text-center">
                        <div class="p-2 sm:p-3 rounded-full bg-green-100 mb-2">
                            <i class="fas fa-check-circle text-green-600 text-base sm:text-lg lg:text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1">Approved</p>
                            <p id="stat-approved" class="text-xl sm:text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-3 sm:p-4 lg:p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex flex-col items-center text-center">
                        <div class="p-2 sm:p-3 rounded-full bg-red-100 mb-2">
                            <i class="fas fa-times-circle text-red-600 text-base sm:text-lg lg:text-xl"></i>
                        </div>
                        <div>
                            <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1">Rejected</p>
                            <p id="stat-rejected" class="text-xl sm:text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter and Search -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md border border-gray-200 mb-6 sm:mb-8">
                <div class="flex flex-col gap-3 sm:gap-4">
                    <div class="grid grid-cols-2 gap-3 sm:gap-4">
                        <div>
                            <select id="status-filter" class="w-full px-3 py-2.5 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="under-review">Under Review</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div>
                            <select id="date-filter" class="w-full px-3 py-2.5 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                <option value="">All Time</option>
                                <option value="this-month">This Month</option>
                                <option value="last-3-months">Last 3 Months</option>
                                <option value="this-year">This Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="relative">
                        <input type="text" id="search" placeholder="Search applications..."
                               class="w-full sm:pl-10 pl-4 pr-4 py-2.5 text-base border border-gray-300 rounded-md focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                        <div class="absolute inset-y-0 left-0 pl-3 sm:flex items-center pointer-events-none hidden">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Applications List -->
            <div id="applications-container" class="space-y-4 sm:space-y-6">
                <!-- Loading state -->
                <div id="loading-state" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
                    <p class="text-sm sm:text-base text-gray-600 mt-4">Loading applications...</p>
                </div>
            </div>

            <!-- Empty State (hidden by default) -->
            <div id="empty-state" class="text-center py-12 hidden">
                <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-file-alt text-gray-400 text-3xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">No Applications Found</h3>
                <p class="text-gray-600 mb-6">You haven't submitted any scholarship applications yet.</p>
                <a href="browse-scholarships.html" 
                   class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
                    <i class="fas fa-search mr-2"></i>
                    Browse Scholarships
                </a>
            </div>
        </div>
    </div>

    <!-- Component Loader Script -->
    <script src="components.js"></script>

    <!-- Page Scripts -->
    <script>
        let allApplications = [];

        // Load applications on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadApplications();
        });

        // Load applications from API
        async function loadApplications() {
            try {
                const response = await fetch('/api/student/applications');
                const result = await response.json();

                if (result.success) {
                    allApplications = result.applications;
                    
                    // Update stats
                    updateStats(result.stats);
                    
                    // Display applications
                    displayApplications(allApplications);
                } else {
                    showError('Failed to load applications');
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                showError('Failed to load applications');
            }
        }

        // Update statistics
        function updateStats(stats) {
            document.getElementById('stat-total').textContent = stats.total_applications || 0;
            document.getElementById('stat-review').textContent = stats.under_review || 0;
            document.getElementById('stat-approved').textContent = stats.approved || 0;
            document.getElementById('stat-rejected').textContent = stats.rejected || 0;
        }

        // Display applications
        function displayApplications(applications) {
            const container = document.getElementById('applications-container');
            const loadingState = document.getElementById('loading-state');
            const emptyState = document.getElementById('empty-state');

            // Hide loading
            if (loadingState) {
                loadingState.style.display = 'none';
            }

            if (applications.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            container.innerHTML = applications.map(app => createApplicationCard(app)).join('');
        }

        // Create application card HTML
        function createApplicationCard(app) {
            const statusConfig = getStatusConfig(app.status);
            const progress = getProgress(app.status);
            const amount = new Intl.NumberFormat('en-PH', { 
                style: 'currency', 
                currency: 'PHP',
                maximumFractionDigits: 0
            }).format(app.amount);

            const submittedDate = app.submitted_at ? new Date(app.submitted_at).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }) : 'Not submitted';

            const deadlineDate = new Date(app.application_deadline).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            const reviewedInfo = app.reviewed_at ? 
                `<span><i class="fas fa-check-circle mr-1"></i>${statusConfig.actionText}: ${new Date(app.reviewed_at).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>` :
                `<span><i class="fas fa-clock mr-1"></i>Deadline: ${deadlineDate}</span>`;

            return `
                <div class="application-card bg-white rounded-lg shadow-md border border-gray-200" data-status="${app.status.toLowerCase()}">
                    <div class="p-4 sm:p-6">
                        <div class="flex flex-col">
                            <div class="flex-1">
                                <div class="flex flex-col sm:flex-row sm:items-center mb-3">
                                    <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-2 sm:mb-0 sm:mr-3">${app.scholarship_title}</h3>
                                    <span class="px-3 py-1 ${statusConfig.bgClass} ${statusConfig.textClass} text-xs sm:text-sm rounded-full w-fit">${statusConfig.label}</span>
                                </div>
                                <p class="text-gray-600 text-xs sm:text-sm mb-2">Application ID: #${String(app.id).padStart(6, '0')}</p>
                                <div class="text-gray-500 text-xs sm:text-sm mb-3">
                                    <p class="mb-1"><strong>Provider:</strong> ${app.provider_name}</p>
                                    ${app.document_count > 0 ? `<p><i class="fas fa-paperclip mr-1"></i>${app.document_count} document(s) uploaded</p>` : ''}
                                </div>
                                <div class="flex flex-col sm:flex-row sm:flex-wrap sm:items-center text-xs sm:text-sm text-gray-500 gap-2 sm:gap-4 mb-3">
                                    <span><i class="fas fa-calendar mr-1"></i>Applied: ${submittedDate}</span>
                                    ${reviewedInfo}
                                    <span><i class="fas fa-dollar-sign mr-1"></i>${amount}</span>
                                </div>
                            </div>
                            <div class="w-full">
                                ${createActionButtons(app, statusConfig)}
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mt-4">
                            <div class="flex justify-between text-xs sm:text-sm text-gray-600 mb-1">
                                <span>Application Progress</span>
                                <span>${progress.percentage}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="${progress.colorClass} h-2 rounded-full" style="width: ${progress.percentage}%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                ${progress.stages.map(stage => `<span class="text-center">${stage}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get status configuration
        function getStatusConfig(status) {
            const configs = {
                'PENDING': {
                    label: 'Pending',
                    bgClass: 'bg-blue-100',
                    textClass: 'text-blue-800',
                    actionText: 'Submitted'
                },
                'UNDER_REVIEW': {
                    label: 'Under Review',
                    bgClass: 'bg-yellow-100',
                    textClass: 'text-yellow-800',
                    actionText: 'Under Review'
                },
                'APPROVED': {
                    label: 'Approved',
                    bgClass: 'bg-green-100',
                    textClass: 'text-green-800',
                    actionText: 'Approved'
                },
                'REJECTED': {
                    label: 'Rejected',
                    bgClass: 'bg-red-100',
                    textClass: 'text-red-800',
                    actionText: 'Rejected'
                }
            };
            return configs[status] || configs['PENDING'];
        }

        // Get progress information
        function getProgress(status) {
            const progressMap = {
                'PENDING': {
                    percentage: 33,
                    colorClass: 'bg-blue-600',
                    stages: ['Submitted', 'Review', 'Decision']
                },
                'UNDER_REVIEW': {
                    percentage: 66,
                    colorClass: 'bg-yellow-600',
                    stages: ['Submitted', 'Under Review', 'Decision']
                },
                'APPROVED': {
                    percentage: 100,
                    colorClass: 'bg-green-600',
                    stages: ['Submitted', 'Reviewed', 'Approved']
                },
                'REJECTED': {
                    percentage: 100,
                    colorClass: 'bg-red-600',
                    stages: ['Submitted', 'Reviewed', 'Rejected']
                }
            };
            return progressMap[status] || progressMap['PENDING'];
        }

        // Create action buttons
        function createActionButtons(app, statusConfig) {
            if (app.status === 'APPROVED') {
                return `
                    <div class="flex space-x-2">
                        <button onclick="viewApplication(${app.id})" 
                                class="w-full sm:w-auto px-4 py-2.5 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors text-sm font-medium">
                            View Details
                        </button>
                    </div>
                `;
            } else if (app.status === 'REJECTED') {
                return `
                    <div class="flex space-x-2">
                        <button onclick="viewApplication(${app.id})" 
                                class="w-full sm:w-auto px-4 py-2.5 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors text-sm font-medium">
                            View Feedback
                        </button>
                    </div>
                `;
            } else {
                return `
                    <div class="flex space-x-2">
                        <button onclick="viewApplication(${app.id})" 
                                class="w-full sm:w-auto px-4 py-2.5 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors text-sm font-medium">
                            View Details
                        </button>
                    </div>
                `;
            }
        }

        // Filter applications
        function filterApplications() {
            const statusFilter = document.getElementById('status-filter').value;
            const search = document.getElementById('search').value.toLowerCase();
            
            let filteredApps = allApplications;
            
            // Status filter
            if (statusFilter) {
                const statusMap = {
                    'pending': 'PENDING',
                    'under-review': 'UNDER_REVIEW',
                    'approved': 'APPROVED',
                    'rejected': 'REJECTED'
                };
                filteredApps = filteredApps.filter(app => app.status === statusMap[statusFilter]);
            }
            
            // Search filter
            if (search) {
                filteredApps = filteredApps.filter(app => 
                    app.scholarship_title.toLowerCase().includes(search) ||
                    app.provider_name.toLowerCase().includes(search)
                );
            }
            
            displayApplications(filteredApps);
        }

        // View application details
        function viewApplication(id) {
            const app = allApplications.find(a => a.id === id);
            if (app) {
                // Navigate to scholarship details page
                window.location.href = `scholarship-details.html?id=${app.scholarship_id}`;
            }
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('applications-container');
            const loadingState = document.getElementById('loading-state');
            
            if (loadingState) {
                loadingState.style.display = 'none';
            }

            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-24 h-24 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-circle text-red-600 text-3xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Error Loading Applications</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <button onclick="loadApplications()" 
                            class="inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors">
                        <i class="fas fa-redo mr-2"></i>
                        Try Again
                    </button>
                </div>
            `;
        }
        
        // Event listeners
        document.getElementById('status-filter').addEventListener('change', filterApplications);
        document.getElementById('search').addEventListener('input', filterApplications);
    </script>

    <!-- Mobile Menu Handler -->
    <script src="/Assets/js/mobile-menu.js"></script>
</body>
</html>