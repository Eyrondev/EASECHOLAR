<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provider Dashboard - EASECHOLAR</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Mobile Responsive Styles -->
    <link rel="stylesheet" href="/Assets/css/mobile-responsive.css">

    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Sidebar component (fixed) -->
    <div id="sidebar-container"></div>
    
    <!-- Navigation component (fixed) -->
    <div id="nav-container"></div>

    <!-- Main content with proper spacing for fixed sidebar and nav -->
    <div class="ml-64 pt-16">
        <div class="p-8">
            <!-- Header component -->
            <div id="header-container"></div>

            <!-- Main Dashboard Content -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column - Charts and Analytics -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- Applications Overview Chart -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-gray-900">Applications Overview</h3>
                            <select id="chart-period" onchange="updateChartPeriod()" class="text-sm border border-gray-300 rounded-md px-3 py-1">
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 3 months</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="h-64">
                            <canvas id="applicationsChart"></canvas>
                        </div>
                    </div>

                    <!-- Recent Applications -->
                    <div class="bg-white rounded-lg shadow-md border border-gray-200">
                        <div class="p-6 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900">Recent Applications</h3>
                                <a href="applications.html" class="text-sm text-green-600 hover:text-green-700 font-medium">
                                    View all
                                </a>
                            </div>
                        </div>
                        <div id="recent-applications-container" class="divide-y divide-gray-200">
                            <!-- Loading state -->
                            <div class="p-6 text-center">
                                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                                <p class="text-sm text-gray-500 mt-2">Loading applications...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Quick Actions and Stats -->
                <div class="space-y-8">
                    <!-- Quick Actions -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                        <div class="space-y-3">
                            <button onclick="createNewScholarship()" class="w-full flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>
                                Create New Scholarship
                            </button>
                            <button onclick="viewPendingApplications()" class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                <i class="fas fa-eye mr-2"></i>
                                Review Applications
                            </button>
                            <button onclick="window.location.href='scholarships.html'" class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                <i class="fas fa-graduation-cap mr-2"></i>
                                Manage Scholarships
                            </button>
                            <button onclick="window.location.href='analytics.html'" class="w-full flex items-center justify-center px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                <i class="fas fa-chart-bar mr-2"></i>
                                View Analytics
                            </button>
                        </div>
                    </div>

                    <!-- Application Status Overview -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Application Status</h3>
                        <div id="status-overview" class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></div>
                                    <span class="text-sm text-gray-700">Pending</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-900" id="count-pending">
                                    <i class="fas fa-spinner fa-spin text-xs"></i>
                                </span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                    <span class="text-sm text-gray-700">Under Review</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-900" id="count-review">
                                    <i class="fas fa-spinner fa-spin text-xs"></i>
                                </span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                    <span class="text-sm text-gray-700">Approved</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-900" id="count-approved">
                                    <i class="fas fa-spinner fa-spin text-xs"></i>
                                </span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-red-500 rounded-full mr-3"></div>
                                    <span class="text-sm text-gray-700">Rejected</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-900" id="count-rejected">
                                    <i class="fas fa-spinner fa-spin text-xs"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Component Loader Script -->
    <script src="components.js"></script>

    <!-- Page Scripts -->
    <script>
        function createNewScholarship() {
            window.location.href = 'scholarships.html?action=create';
        }
        
        function viewPendingApplications() {
            window.location.href = 'applications.html?status=pending';
        }
        
        function generateReport() {
            alert('Generating comprehensive scholarship report...');
            // In a real application, this would generate and download a report
        }
        
        function viewApplication(applicationId) {
            window.location.href = `applications.html?id=${applicationId}`;
        }
        
        // View student documents
        async function viewDocuments(applicationId, studentName) {
            try {
                const response = await fetch(`/api/provider/application/${applicationId}/documents`);
                const result = await response.json();
                
                if (result.success && result.documents) {
                    showDocumentsModal(result.documents, studentName, applicationId);
                } else {
                    alert('No documents found for this application');
                }
            } catch (error) {
                console.error('Error fetching documents:', error);
                alert('Failed to load documents. Please try again.');
            }
        }
        
        // Show documents modal
        function showDocumentsModal(documents, studentName, applicationId) {
            const modal = document.createElement('div');
            modal.id = 'documentsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            const documentsList = documents.length > 0 ? documents.map(doc => `
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-file-${getFileIcon(doc.file_type)} text-2xl text-gray-400"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">${doc.document_type || 'Document'}</p>
                            <p class="text-xs text-gray-500">${doc.file_name || 'N/A'}</p>
                            ${doc.uploaded_at ? `<p class="text-xs text-gray-400">Uploaded: ${new Date(doc.uploaded_at).toLocaleDateString()}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="viewDocument('${doc.file_path}')" class="px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                            <i class="fas fa-eye mr-1"></i> View
                        </button>
                        <button onclick="downloadDocument('${doc.file_path}', '${doc.file_name}')" class="px-3 py-1.5 text-sm bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                            <i class="fas fa-download mr-1"></i> Download
                        </button>
                    </div>
                </div>
            `).join('') : `
                <div class="text-center py-8">
                    <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                    <p class="text-sm text-gray-500">No documents uploaded yet</p>
                </div>
            `;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] overflow-hidden">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-semibold text-gray-900">Application Documents</h3>
                                <p class="text-sm text-gray-500 mt-1">Student: ${studentName}</p>
                            </div>
                            <button onclick="closeDocumentsModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <div class="space-y-3">
                            ${documentsList}
                        </div>
                    </div>
                    <div class="p-6 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-end">
                            <button onclick="closeDocumentsModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Close documents modal
        function closeDocumentsModal() {
            const modal = document.getElementById('documentsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Get file icon based on file type
        function getFileIcon(fileType) {
            if (!fileType) return 'alt';
            
            const type = fileType.toLowerCase();
            if (type.includes('pdf')) return 'pdf';
            if (type.includes('image') || type.includes('jpg') || type.includes('png') || type.includes('jpeg')) return 'image';
            if (type.includes('word') || type.includes('doc')) return 'word';
            if (type.includes('excel') || type.includes('xls') || type.includes('csv')) return 'excel';
            return 'alt';
        }
        
        // View document in new tab
        function viewDocument(filePath) {
            if (!filePath) {
                alert('Document path not available');
                return;
            }
            window.open(`/uploads/${filePath}`, '_blank');
        }
        
        // Download document
        function downloadDocument(filePath, fileName) {
            if (!filePath) {
                alert('Document path not available');
                return;
            }
            
            const link = document.createElement('a');
            link.href = `/uploads/${filePath}`;
            link.download = fileName || 'document';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Format time ago
        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return date.toLocaleDateString();
        }
        
        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'PENDING': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending Review</span>',
                'UNDER_REVIEW': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Under Review</span>',
                'APPROVED': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Approved</span>',
                'REJECTED': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Rejected</span>'
            };
            return badges[status] || badges['PENDING'];
        }
        
        // Load recent applications
        async function loadRecentApplications() {
            try {
                const response = await fetch('/api/provider/applications');
                const result = await response.json();
                
                const container = document.getElementById('recent-applications-container');
                
                if (result.success && result.applications && result.applications.length > 0) {
                    // Show only the 5 most recent
                    const recentApps = result.applications.slice(0, 5);
                    
                    container.innerHTML = recentApps.map(app => `
                        <div class="p-6 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-white font-semibold">
                                    ${(app.student_first_name || 'U').charAt(0)}${(app.student_last_name || '').charAt(0)}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">${app.student_first_name || ''} ${app.student_last_name || ''}</p>
                                            <p class="text-sm text-gray-500">${app.scholarship_title || 'N/A'}</p>
                                        </div>
                                        <div class="text-right">
                                            ${getStatusBadge(app.status)}
                                            <p class="text-xs text-gray-500 mt-1">${timeAgo(app.created_at)}</p>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1">
                                        ${app.gpa ? 'GPA: ' + app.gpa : ''} 
                                        ${app.school_name ? 'â€¢ ' + app.school_name : ''}
                                    </p>
                                    <div class="flex space-x-2 mt-3">
                                        <button onclick="event.stopPropagation(); viewApplication(${app.id})" class="px-3 py-1.5 text-xs bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                                            <i class="fas fa-eye mr-1"></i> View Application
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="p-6 text-center">
                            <i class="fas fa-inbox text-4xl text-gray-300 mb-2"></i>
                            <p class="text-sm text-gray-500">No applications yet</p>
                            <p class="text-xs text-gray-400 mt-1">Applications will appear here once students start applying</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                document.getElementById('recent-applications-container').innerHTML = `
                    <div class="p-6 text-center">
                        <i class="fas fa-exclamation-triangle text-2xl text-red-400 mb-2"></i>
                        <p class="text-sm text-gray-500">Failed to load applications</p>
                    </div>
                `;
            }
        }
        
        // Load status counts
        async function loadStatusCounts() {
            try {
                const response = await fetch('/api/provider/dashboard-stats');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const data = result.data;
                    document.getElementById('count-pending').textContent = data.pending_applications || 0;
                    document.getElementById('count-review').textContent = data.review_applications || 0;
                    document.getElementById('count-approved').textContent = data.approved_applications || 0;
                    document.getElementById('count-rejected').textContent = data.rejected_applications || 0;
                } else {
                    // Show zeros if no data
                    document.getElementById('count-pending').textContent = '0';
                    document.getElementById('count-review').textContent = '0';
                    document.getElementById('count-approved').textContent = '0';
                    document.getElementById('count-rejected').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading status counts:', error);
                document.getElementById('count-pending').textContent = '0';
                document.getElementById('count-review').textContent = '0';
                document.getElementById('count-approved').textContent = '0';
                document.getElementById('count-rejected').textContent = '0';
            }
        }
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadRecentApplications();
            loadStatusCounts();
            initializeChart();
            console.log('Provider dashboard loaded');
        });
        
        // Chart variables
        let applicationsChart = null;
        let chartData = null;
        
        // Initialize the chart
        function initializeChart() {
            const ctx = document.getElementById('applicationsChart');
            if (!ctx) {
                console.error('Chart canvas not found');
                return;
            }
            
            applicationsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Pending',
                            data: [],
                            borderColor: 'rgb(234, 179, 8)',
                            backgroundColor: 'rgba(234, 179, 8, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Approved',
                            data: [],
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Rejected',
                            data: [],
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
            
            loadChartData(30); // Load last 30 days by default
        }
        
        // Load chart data from API
        async function loadChartData(days) {
            try {
                console.log(`Loading chart data for ${days} days...`);
                const response = await fetch(`/api/provider/applications-chart?days=${days}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    console.log('Chart data loaded:', result.data);
                    chartData = result.data;
                    updateChart(chartData);
                } else {
                    console.error('Failed to load chart data:', result.message);
                    showChartError('Unable to load chart data');
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
                showChartError('Failed to connect to server');
            }
        }
        
        // Update chart with data
        function updateChart(data) {
            if (!applicationsChart) return;
            
            applicationsChart.data.labels = data.labels || [];
            applicationsChart.data.datasets[0].data = data.pending || [];
            applicationsChart.data.datasets[1].data = data.approved || [];
            applicationsChart.data.datasets[2].data = data.rejected || [];
            applicationsChart.update();
        }
        
        // Show error message on chart
        function showChartError(message) {
            if (!applicationsChart) return;
            
            // Clear chart data
            applicationsChart.data.labels = ['No Data'];
            applicationsChart.data.datasets[0].data = [0];
            applicationsChart.data.datasets[1].data = [0];
            applicationsChart.data.datasets[2].data = [0];
            applicationsChart.update();
            
            console.warn(`Chart error: ${message}`);
        }
        
        // Update chart period
        function updateChartPeriod() {
            const select = document.getElementById('chart-period');
            const days = parseInt(select.value);
            console.log(`Chart period changed to ${days} days`);
            loadChartData(days);
        }
    </script>

    <!-- Mobile Menu Handler -->
    <script src="/Assets/js/mobile-menu.js"></script>
</body>
</html>