<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Review - EASECHOLAR</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/Assets/images/main_icon.png">
    <link rel="apple-touch-icon" href="/Assets/images/main_icon.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Mobile Responsive Styles -->
    <link rel="stylesheet" href="/Assets/css/mobile-responsive.css">

</head>
<body class="bg-gray-50 font-sans">
    <!-- Sidebar component (fixed) -->
    <div id="sidebar-container"></div>
    
    <!-- Navigation component (fixed) -->
    <div id="nav-container"></div>

    <!-- Main content with proper spacing for fixed sidebar and nav -->
    <div class="ml-0 lg:ml-64 pt-20 sm:pt-16">
        <div class="p-3 sm:p-6 lg:p-8">
            <!-- Page Header -->
            <div class="mb-4 sm:mb-6 lg:mb-8">
                <div class="sm:flex sm:items-center sm:justify-between">
                    <div class="flex-1 min-w-0">
                        <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">Application Review</h1>
                        <p class="mt-1 text-xs sm:text-sm lg:text-base text-gray-600">Review and manage scholarship applications</p>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mb-4 sm:mb-6 lg:mb-8">
                <div class="bg-white p-3 sm:p-4 lg:p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-file-alt text-blue-600 text-base sm:text-lg lg:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-3 lg:ml-4 flex-1 min-w-0">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Total Applications</p>
                            <p id="total-apps" class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">
                                <span class="inline-block animate-pulse bg-gray-200 rounded w-12 h-6 sm:h-8"></span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-3 sm:p-4 lg:p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-yellow-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-clock text-yellow-600 text-base sm:text-lg lg:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-3 lg:ml-4 flex-1 min-w-0">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Pending Review</p>
                            <p id="pending-apps" class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">
                                <span class="inline-block animate-pulse bg-gray-200 rounded w-12 h-6 sm:h-8"></span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-3 sm:p-4 lg:p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-check-circle text-green-600 text-base sm:text-lg lg:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-3 lg:ml-4 flex-1 min-w-0">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Approved</p>
                            <p id="approved-apps" class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">
                                <span class="inline-block animate-pulse bg-gray-200 rounded w-12 h-6 sm:h-8"></span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-3 sm:p-4 lg:p-6 rounded-lg shadow-md border border-gray-200">
                    <div class="flex items-center">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-times-circle text-red-600 text-base sm:text-lg lg:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-3 lg:ml-4 flex-1 min-w-0">
                            <p class="text-xs sm:text-sm font-medium text-gray-600 truncate">Rejected</p>
                            <p id="rejected-apps" class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">
                                <span class="inline-block animate-pulse bg-gray-200 rounded w-12 h-6 sm:h-8"></span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="bg-white p-3 sm:p-4 lg:p-6 rounded-lg shadow-md border border-gray-200 mb-4 sm:mb-6 lg:mb-8">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3">
                    <div class="sm:col-span-2">
                        <div class="relative">
                            <input type="text" id="search" placeholder="Search applications..."
                                   class="w-full pl-9 pr-3 py-2.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400 text-sm"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <select id="scholarship-filter" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white">
                            <option value="">All Scholarships</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    
                    <div>
                        <select id="status-filter" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white">
                            <option value="">All Status</option>
                            <option value="PENDING">Pending Review</option>
                            <option value="APPROVED">Approved</option>
                            <option value="REJECTED">Rejected</option>
                            <option value="UNDER_REVIEW">Under Review</option>
                        </select>
                    </div>
                    
                    <div>
                        <select id="sort-by" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white">
                            <option value="date-desc">Latest First</option>
                            <option value="date-asc">Oldest First</option>
                            <option value="name-asc">Name A-Z</option>
                            <option value="name-desc">Name Z-A</option>
                            <option value="gpa-desc">Highest GPA</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Applications List -->
            <div id="applications-list" class="space-y-3 sm:space-y-4">
                <!-- Loading state -->
                <div class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-green-500 mb-4"></i>
                    <p class="text-gray-600">Loading applications...</p>
                </div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-3" style="display: none;">
                <div id="pagination-info" class="text-xs sm:text-sm text-gray-700"></div>
                <div id="pagination-controls" class="flex items-center space-x-2"></div>
            </div>
        </div>
    </div>

    <!-- Application Detail Modal -->
    <div id="application-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 p-4">
        <div class="relative top-4 sm:top-20 mx-auto p-4 sm:p-6 border w-full sm:w-4/5 max-w-4xl shadow-lg rounded-lg bg-white mb-10">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg sm:text-xl lg:text-2xl font-bold text-gray-900">Application Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 min-w-[44px] min-h-[44px] flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="modal-content" class="space-y-6">
                <!-- Content will be loaded dynamically -->
            </div>
            
            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-2">
                <button onclick="closeModal()" class="w-full sm:w-auto px-4 py-2.5 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 min-h-[44px]">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Review Action Modal -->
    <div id="review-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 p-4">
        <div class="relative top-10 sm:top-20 mx-auto p-4 sm:p-6 border w-full max-w-md shadow-lg rounded-lg bg-white">
            <div class="flex items-center justify-between mb-4">
                <h3 id="review-modal-title" class="text-base sm:text-lg font-bold text-gray-900 flex-1 pr-2"></h3>
                <button onclick="closeReviewModal()" class="text-gray-400 hover:text-gray-600 min-w-[44px] min-h-[44px] flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes / Reason</label>
                    <textarea id="review-notes" rows="4" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="Enter notes or reason for this action..."></textarea>
                </div>
            </div>
            
            <div class="mt-6 flex flex-col sm:flex-row justify-end gap-2">
                <button onclick="closeReviewModal()" class="w-full sm:w-auto px-4 py-2.5 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 min-h-[44px]">
                    Cancel
                </button>
                <button id="confirm-review-btn" onclick="confirmReviewAction()" class="w-full sm:w-auto px-4 py-2.5 rounded-md text-sm font-medium text-white min-h-[44px]">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Component Loader Script -->
    <script src="components.js"></script>

    <!-- Page Scripts -->
    <script>
        let allApplications = [];
        let filteredApplications = [];
        let currentReviewAction = null;
        let currentApplicationId = null;

        // Load applications on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadApplications();
        });

        async function loadApplications() {
            try {
                const response = await fetch('/api/provider/applications');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Applications data:', data);

                if (data.success) {
                    allApplications = data.applications || [];
                    filteredApplications = [...allApplications];
                    renderApplications();
                    updateStats();
                    populateScholarshipFilter();
                } else {
                    showError(data.message || 'Failed to load applications');
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                showError(`Error connecting to server: ${error.message}`);
            }
        }

        function renderApplications() {
            const container = document.getElementById('applications-list');
            
            if (filteredApplications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-600">No applications found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredApplications.map(app => {
                // Count total scholarships for this student
                const studentScholarshipCount = allApplications.filter(a => a.student_id === app.student_id).length;
                
                return `
                <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden ${app.status === 'REJECTED' ? 'opacity-75' : ''}">
                    <div class="p-4 sm:p-6">
                        <div class="flex items-start justify-between mb-3 sm:mb-4">
                            <div class="flex items-start space-x-2 sm:space-x-4 flex-1 min-w-0">
                                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center text-white font-bold text-sm sm:text-lg flex-shrink-0">
                                    ${getInitials(app.student_first_name, app.student_last_name)}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-base sm:text-lg font-semibold text-gray-900 truncate">${app.student_first_name} ${app.student_last_name}</h3>
                                    <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 mt-1">
                                        <span class="text-xs sm:text-sm text-gray-500 truncate">${app.student_email}</span>
                                        <span class="text-xs sm:text-sm text-gray-500 hidden sm:inline">${app.school_name || 'N/A'}</span>
                                        ${app.gpa ? `<span class="text-xs sm:text-sm text-gray-500">GPA: ${app.gpa}</span>` : ''}
                                    </div>
                                    <div class="flex flex-wrap items-center gap-2 mt-2">
                                        ${studentScholarshipCount > 1 ? `
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                scholarship - ${studentScholarshipCount}
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-end sm:items-center gap-2 sm:gap-3 flex-shrink-0 ml-2">
                                ${getStatusBadge(app.status)}
                                <span class="text-xs sm:text-sm text-gray-500 whitespace-nowrap">
                                    ${app.submitted_at ? new Date(app.submitted_at).toLocaleDateString() : 'N/A'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="mb-3 sm:mb-4">
                            <h4 class="font-medium text-sm sm:text-base text-gray-900 mb-1 sm:mb-2">Applied for: ${app.scholarship_title}</h4>
                            <p class="text-gray-600 text-xs sm:text-sm line-clamp-2">${app.cover_letter || 'No cover letter provided'}</p>
                            ${app.reviewer_notes ? `
                                <div class="mt-2 p-2 sm:p-3 ${app.status === 'APPROVED' ? 'bg-green-50' : 'bg-red-50'} rounded-md">
                                    <p class="text-xs sm:text-sm ${app.status === 'APPROVED' ? 'text-green-800' : 'text-red-800'}">
                                        <strong>Review Notes:</strong> ${app.reviewer_notes}
                                    </p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mb-3 sm:mb-4">
                            <div>
                                <p class="text-xs sm:text-sm text-gray-500">Scholarship Amount</p>
                                <p class="font-semibold text-sm sm:text-base text-gray-900 truncate">₱${parseFloat(app.scholarship_amount || 0).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-xs sm:text-sm text-gray-500">Documents</p>
                                <p class="font-semibold text-sm sm:text-base ${app.documents_count > 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${app.documents_count > 0 ? app.documents_count + ' file(s)' : 'Missing'}
                                </p>
                            </div>
                            <div>
                                <p class="text-xs sm:text-sm text-gray-500">Status</p>
                                <p class="font-semibold text-sm sm:text-base text-gray-900">${formatStatus(app.status)}</p>
                            </div>
                            <div>
                                <p class="text-xs sm:text-sm text-gray-500">Application ID</p>
                                <p class="font-semibold text-sm sm:text-base text-gray-900">#${app.id}</p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3">
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button onclick="viewApplicationDetails(${app.id})" class="w-full sm:w-auto inline-flex items-center justify-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                    <i class="fas fa-eye w-4 h-4 mr-2"></i>
                                    <span class="hidden sm:inline">View Details</span>
                                    <span class="sm:hidden">Details</span>
                                </button>
                                ${app.documents_count > 0 ? `
                                    <button onclick="viewDocuments(${app.id})" class="w-full sm:w-auto inline-flex items-center justify-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                        <i class="fas fa-file-pdf w-4 h-4 mr-2"></i>
                                        <span class="hidden sm:inline">Documents</span>
                                        <span class="sm:hidden">Docs</span>
                                        <span class="ml-1">(${app.documents_count})</span>
                                    </button>
                                ` : ''}
                            </div>
                            ${app.status === 'PENDING' || app.status === 'UNDER_REVIEW' ? `
                                <div class="flex flex-col sm:flex-row gap-2">
                                    <button onclick="openReviewModal(${app.id}, 'APPROVED')" class="w-full sm:w-auto inline-flex items-center justify-center px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700">
                                        <i class="fas fa-check w-4 h-4 mr-2"></i>
                                        Approve
                                    </button>
                                    <button onclick="openReviewModal(${app.id}, 'REJECTED')" class="w-full sm:w-auto inline-flex items-center justify-center px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700">
                                        <i class="fas fa-times w-4 h-4 mr-2"></i>
                                        Reject
                                    </button>
                                    ${app.status !== 'UNDER_REVIEW' ? `
                                        <button onclick="openReviewModal(${app.id}, 'UNDER_REVIEW')" class="w-full sm:w-auto inline-flex items-center justify-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                            <i class="fas fa-pause w-4 h-4 mr-2"></i>
                                            Hold
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function updateStats() {
            const total = allApplications.length;
            const pending = allApplications.filter(a => a.status === 'PENDING').length;
            const approved = allApplications.filter(a => a.status === 'APPROVED').length;
            const rejected = allApplications.filter(a => a.status === 'REJECTED').length;

            document.getElementById('total-apps').textContent = total;
            document.getElementById('pending-apps').textContent = pending;
            document.getElementById('approved-apps').textContent = approved;
            document.getElementById('rejected-apps').textContent = rejected;
        }

        function populateScholarshipFilter() {
            const scholarships = [...new Set(allApplications.map(a => ({
                id: a.scholarship_id,
                title: a.scholarship_title
            })).map(s => JSON.stringify(s)))].map(s => JSON.parse(s));

            const filter = document.getElementById('scholarship-filter');
            const currentValue = filter.value;
            
            filter.innerHTML = '<option value="">All Scholarships</option>' +
                scholarships.map(s => `<option value="${s.id}">${s.title}</option>`).join('');
            
            filter.value = currentValue;
        }

        function getInitials(firstName, lastName) {
            return ((firstName || '?').charAt(0) + (lastName || '?').charAt(0)).toUpperCase();
        }

        function getStatusBadge(status) {
            const badges = {
                'PENDING': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pending Review</span>',
                'APPROVED': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Approved</span>',
                'REJECTED': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Rejected</span>',
                'UNDER_REVIEW': '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Under Review</span>'
            };
            return badges[status] || badges['PENDING'];
        }

        function formatStatus(status) {
            return status.replace('_', ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
        }

        async function viewApplicationDetails(id) {
            try {
                const response = await fetch(`/api/provider/application/${id}`);
                const data = await response.json();

                if (data.success) {
                    const app = data.application;
                    console.log('Application data received:', app); // Debug log
                    console.log('Phone number:', app.phone_number);
                    console.log('Guardian phone:', app.guardian_phone);
                    console.log('School name:', app.school_name);
                    console.log('GPA:', app.gpa);
                    
                    const modalContent = document.getElementById('modal-content');
                    modalContent.innerHTML = `
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                            <div>
                                <h4 class="font-semibold text-base sm:text-lg text-gray-900 mb-2">Student Information</h4>
                                <dl class="space-y-2">
                                    <div>
                                        <dt class="text-xs sm:text-sm text-gray-500">Name</dt>
                                        <dd class="text-sm sm:text-base font-medium text-gray-900">${app.first_name} ${app.last_name}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-xs sm:text-sm text-gray-500">Email</dt>
                                        <dd class="text-sm sm:text-base font-medium text-gray-900 break-all">${app.user_email}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-xs sm:text-sm text-gray-500">Phone</dt>
                                        <dd class="text-sm sm:text-base font-medium text-gray-900">${app.phone_number || app.guardian_phone || 'N/A'}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-xs sm:text-sm text-gray-500">School</dt>
                                        <dd class="text-sm sm:text-base font-medium text-gray-900">${app.school_name || 'N/A'}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-xs sm:text-sm text-gray-500">GPA</dt>
                                        <dd class="text-sm sm:text-base font-medium text-gray-900">${app.gpa || 'N/A'}</dd>
                                    </div>
                                </dl>
                            </div>
                            <div>
                                <h4 class="font-semibold text-base sm:text-lg text-gray-900 mb-2">Application Details</h4>
                                <dl class="space-y-2">
                                    <div>
                                        <dt class="text-xs sm:text-sm text-gray-500">Scholarship</dt>
                                        <dd class="text-sm sm:text-base font-medium text-gray-900">${app.scholarship_title}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-xs sm:text-sm text-gray-500">Amount</dt>
                                        <dd class="text-sm sm:text-base font-medium text-gray-900">₱${parseFloat(app.scholarship_amount).toLocaleString()}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-xs sm:text-sm text-gray-500">Status</dt>
                                        <dd class="text-sm sm:text-base font-medium">${getStatusBadge(app.status)}</dd>
                                    </div>
                                    <div>
                                        <dt class="text-xs sm:text-sm text-gray-500">Submitted</dt>
                                        <dd class="text-sm sm:text-base font-medium text-gray-900">${app.submitted_at ? new Date(app.submitted_at).toLocaleString() : 'N/A'}</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-semibold text-base sm:text-lg text-gray-900 mb-2">Cover Letter</h4>
                            <p class="text-xs sm:text-sm text-gray-600">${app.cover_letter || 'No cover letter provided'}</p>
                        </div>
                        ${app.reviewer_notes ? `
                            <div class="mt-4">
                                <h4 class="font-semibold text-base sm:text-lg text-gray-900 mb-2">Review Notes</h4>
                                <p class="text-xs sm:text-sm text-gray-600">${app.reviewer_notes}</p>
                            </div>
                        ` : ''}
                    `;
                    document.getElementById('application-modal').classList.remove('hidden');
                } else {
                    alert('Failed to load application details');
                }
            } catch (error) {
                console.error('Error loading application:', error);
                alert('Error loading application details');
            }
        }

        function closeModal() {
            document.getElementById('application-modal').classList.add('hidden');
        }

        async function viewDocuments(applicationId) {
            try {
                console.log('Fetching documents for application:', applicationId);
                const response = await fetch(`/api/provider/application/${applicationId}/documents`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Documents result:', result);
                
                if (result.success) {
                    // Get student name from the application
                    const app = allApplications.find(a => a.id === applicationId);
                    const studentName = app ? `${app.student_first_name} ${app.student_last_name}` : 'Student';
                    
                    // Show modal even if documents array is empty
                    const documents = result.documents || [];
                    showDocumentsModal(documents, studentName, applicationId);
                } else {
                    alert(result.message || 'No documents found for this application');
                }
            } catch (error) {
                console.error('Error fetching documents:', error);
                alert(`Failed to load documents: ${error.message}. Please check the console for details.`);
            }
        }
        
        function showDocumentsModal(documents, studentName, applicationId) {
            console.log('Documents received:', documents); // Debug log
            console.log('Number of documents:', documents.length);
            
            const modal = document.createElement('div');
            modal.id = 'documentsModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            const documentsList = documents.length > 0 ? documents.map(doc => {
                console.log('========================================');
                console.log('Document object:', doc);
                console.log('Document file_path:', doc.file_path);
                console.log('Document file_name:', doc.file_name);
                console.log('Document type:', doc.document_type);
                console.log('========================================');
                
                // Escape the file path properly for onclick
                const escapedPath = (doc.file_path || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                const escapedName = (doc.file_name || 'document').replace(/'/g, "\\'");
                
                return `
                <div class="flex items-center justify-between p-3 sm:p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                    <div class="flex items-center space-x-2 sm:space-x-3 flex-1 min-w-0">
                        <i class="fas fa-file-${getFileIcon(doc.file_type)} text-xl sm:text-2xl text-gray-400 flex-shrink-0"></i>
                        <div class="min-w-0">
                            <p class="text-xs sm:text-sm font-medium text-gray-900 truncate">${doc.document_type || 'Document'}</p>
                            <p class="text-xs text-gray-500 truncate">${doc.file_name || 'N/A'}</p>
                            ${doc.uploaded_at ? `<p class="text-xs text-gray-400">Uploaded: ${new Date(doc.uploaded_at).toLocaleDateString()}</p>` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2 flex-shrink-0">
                        <button onclick="downloadDocument('${escapedPath}', '${escapedName}')" class="px-2 sm:px-3 py-1.5 text-xs sm:text-sm bg-green-600 text-white rounded hover:bg-green-700 transition-colors whitespace-nowrap">
                            <i class="fas fa-download mr-1"></i> <span class="hidden sm:inline">Download</span>
                        </button>
                    </div>
                </div>
            `}).join('') : `
                <div class="text-center py-8">
                    <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                    <p class="text-sm text-gray-500">No documents uploaded yet</p>
                </div>
            `;
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[85vh] overflow-hidden">
                    <div class="p-4 sm:p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg sm:text-xl font-semibold text-gray-900">Application Documents</h3>
                                <p class="text-xs sm:text-sm text-gray-500 mt-1">Student: ${studentName}</p>
                            </div>
                            <button onclick="closeDocumentsModal()" class="text-gray-400 hover:text-gray-600 min-w-[44px] min-h-[44px] flex items-center justify-center">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 sm:p-6 overflow-y-auto max-h-[60vh]">
                        <div class="space-y-3">
                            ${documentsList}
                        </div>
                    </div>
                    <div class="p-4 sm:p-6 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-end">
                            <button onclick="closeDocumentsModal()" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeDocumentsModal() {
            const modal = document.getElementById('documentsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function getFileIcon(fileType) {
            if (!fileType) return 'alt';
            
            const type = fileType.toLowerCase();
            if (type.includes('pdf')) return 'pdf';
            if (type.includes('image') || type.includes('jpg') || type.includes('png') || type.includes('jpeg')) return 'image';
            if (type.includes('word') || type.includes('doc')) return 'word';
            if (type.includes('excel') || type.includes('xls') || type.includes('csv')) return 'excel';
            return 'alt';
        }
        
        function viewDocumentFile(filePath) {
            if (!filePath) {
                alert('Document path not available');
                return;
            }
            // Normalize path: replace backslashes with forward slashes
            const normalizedPath = filePath.replace(/\\/g, '/');
            // Ensure path starts with /
            const url = normalizedPath.startsWith('/') ? normalizedPath : '/' + normalizedPath;
            
            console.log('Original path:', filePath);
            console.log('Normalized path:', normalizedPath);
            console.log('Opening document:', url);
            window.open(url, '_blank');
        }
        
        function downloadDocument(filePath, fileName) {
            if (!filePath) {
                alert('Document path not available');
                return;
            }
            
            // Clean the path first - remove any weird encoding
            let cleanPath = filePath;
            
            // Replace backslashes with forward slashes
            cleanPath = cleanPath.replace(/\\/g, '/');
            
            // If path doesn't start with 'uploads/', add it
            if (!cleanPath.startsWith('uploads/') && !cleanPath.startsWith('/uploads/')) {
                cleanPath = 'uploads/' + cleanPath;
            }
            
            // Ensure it starts with /
            const url = cleanPath.startsWith('/') ? cleanPath : '/' + cleanPath;
            
            console.log('Original path:', filePath);
            console.log('Clean path:', cleanPath);
            console.log('Final URL:', url);
            console.log('Downloading document:', url);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        console.error('Response not OK:', response.status, response.statusText);
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Create blob link to download
                    const blobUrl = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = fileName || 'document';
                    document.body.appendChild(link);
                    link.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(blobUrl);
                    }, 100);
                    
                    console.log('Download successful');
                })
                .catch(error => {
                    console.error('Download error:', error);
                    alert(`Failed to download: ${error.message}`);
                });
        }

        function openReviewModal(applicationId, action) {
            currentApplicationId = applicationId;
            currentReviewAction = action;

            const titles = {
                'APPROVED': 'Approve Application',
                'REJECTED': 'Reject Application',
                'UNDER_REVIEW': 'Put Application Under Review'
            };

            const colors = {
                'APPROVED': 'bg-green-600 hover:bg-green-700',
                'REJECTED': 'bg-red-600 hover:bg-red-700',
                'UNDER_REVIEW': 'bg-blue-600 hover:bg-blue-700'
            };

            document.getElementById('review-modal-title').textContent = titles[action];
            document.getElementById('confirm-review-btn').className = `px-4 py-2 rounded-md text-white ${colors[action]}`;
            document.getElementById('review-notes').value = '';
            document.getElementById('review-modal').classList.remove('hidden');
        }

        function closeReviewModal() {
            document.getElementById('review-modal').classList.add('hidden');
            currentApplicationId = null;
            currentReviewAction = null;
        }

        async function confirmReviewAction() {
            const notes = document.getElementById('review-notes').value;

            if (!currentApplicationId || !currentReviewAction) return;

            try {
                const response = await fetch(`/api/provider/application/${currentApplicationId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: currentReviewAction,
                        notes: notes
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeReviewModal();
                    loadApplications(); // Reload applications
                    alert(data.message);
                } else {
                    alert(data.message || 'Failed to update application');
                }
            } catch (error) {
                console.error('Error updating application:', error);
                alert('Error updating application');
            }
        }

        function filterApplications() {
            const search = document.getElementById('search').value.toLowerCase();
            const scholarshipFilter = document.getElementById('scholarship-filter').value;
            const statusFilter = document.getElementById('status-filter').value;

            filteredApplications = allApplications.filter(app => {
                const matchesSearch = search === '' || 
                    app.student_first_name.toLowerCase().includes(search) ||
                    app.student_last_name.toLowerCase().includes(search) ||
                    app.student_email.toLowerCase().includes(search);
                
                const matchesScholarship = scholarshipFilter === '' || app.scholarship_id == scholarshipFilter;
                const matchesStatus = statusFilter === '' || app.status === statusFilter;

                return matchesSearch && matchesScholarship && matchesStatus;
            });

            renderApplications();
        }

        function showError(message) {
            const container = document.getElementById('applications-list');
            container.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                    <p class="text-gray-600">${message}</p>
                    <button onclick="loadApplications()" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        Retry
                    </button>
                </div>
            `;
        }

        function exportApplications() {
            alert('Export functionality will be implemented soon');
        }

        // Event listeners
        document.getElementById('search').addEventListener('input', filterApplications);
        document.getElementById('scholarship-filter').addEventListener('change', filterApplications);
        document.getElementById('status-filter').addEventListener('change', filterApplications);
    </script>

    <!-- Mobile Menu Handler -->
    <script src="/Assets/js/mobile-menu.js"></script>
</body>
</html>